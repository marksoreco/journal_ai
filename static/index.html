<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Journal AI</title>
    <style>
        body {
            background: #181a1b;
            color: #f3f3f3;
            font-family: 'Segoe UI', Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            margin-right: 150px; /* Create space for Gmail panel */
        }
        h1 {
            margin-top: 2rem;
            font-size: 2.5rem;
            letter-spacing: 2px;
            font-family: 'Varennes', serif;
        }
        .upload-container {
            background: #23272a;
            border: 2px dashed #444;
            border-radius: 12px;
            padding: 2rem;
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 350px;
            transition: border-color 0.2s;
        }
        .upload-container.dragover {
            border-color: #4f8cff;
        }
        .upload-label {
            margin-bottom: 1rem;
            font-size: 1.1rem;
            color: #b0b0b0;
        }
        .file-input {
            display: none;
        }
        .browse-btn {
            background: #4f8cff;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 0.5rem 1.2rem;
            font-size: 1rem;
            cursor: pointer;
            margin-bottom: 1rem;
            transition: background 0.2s;
        }
        .browse-btn:hover {
            background: #357ae8;
        }
        .preview {
            margin: 1rem 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .preview img {
            max-width: 180px;
            max-height: 180px;
            border-radius: 8px;
            box-shadow: 0 2px 8px #000a;
            margin-bottom: 0.5rem;
        }
        .submit-btn {
            background: #1db954;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 0.6rem 1.5rem;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 1rem;
            transition: background 0.2s;
        }
        .submit-btn:disabled {
            background: #444;
            cursor: not-allowed;
        }
        .todoist-btn {
            background: #db4c3f;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 0.6rem 1.5rem;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 1rem;
            margin-left: 1rem;
            transition: background 0.2s;
        }
        .todoist-btn:hover:not(:disabled) {
            background: #c53727;
        }
        .todoist-btn:disabled {
            background: #444;
            cursor: not-allowed;
        }
        .message {
            margin-top: 1rem;
            font-size: 1rem;
        }
        .ocr-result {
            margin-top: 2rem;
            padding: 1.2rem 1.5rem;
            background: #23272a;
            border-radius: 10px;
            color: #f8f8f2;
            font-family: 'Fira Mono', 'Menlo', 'Consolas', 'Liberation Mono', monospace;
            font-size: 9pt;
            box-shadow: 0 2px 8px #000a;
            max-width: 700px;
            width: 700px;
            word-break: break-word;
            white-space: pre-wrap;
            display: none;
        }
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: #23272a;
            border-radius: 12px;
            padding: 2rem;
            width: 500px;
            max-width: 90vw;
            color: #f3f3f3;
        }
        .modal-content h3 {
            margin-top: 0;
            color: #ff6b6b;
        }
        .confidence-info {
            color: #ffa500;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        .task-review {
            margin-bottom: 1.5rem;
        }
        .task-review label {
            display: block;
            margin-bottom: 0.5rem;
            color: #b0b0b0;
        }
        .task-review textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #444;
            border-radius: 6px;
            background: #181a1b;
            color: #f3f3f3;
            font-family: inherit;
            resize: vertical;
        }
        .task-review textarea:focus {
            outline: none;
            border-color: #4f8cff;
        }
        .task-review textarea:disabled {
            background: #2a2a2a;
            color: #ccc;
            cursor: not-allowed;
        }
        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        .accept-btn {
            background: #1db954;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .accept-btn:hover {
            background: #1aa34a;
        }
        .edit-btn {
            background: #ff9800;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .edit-btn:hover {
            background: #f57c00;
        }
        .back-btn {
            background: #9c27b0;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .back-btn:hover {
            background: #7b1fa2;
        }
        .cancel-btn {
            background: #f44336;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .cancel-btn:hover {
            background: #d32f2f;
        }
        
        #logoutBtn:hover {
            background: #d32f2f !important;
        }
        
        #loginBtn:hover {
            background: #45a049 !important;
        }
        
        .confirm-btn {
            background: #2196F3;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 0.6rem 1.2rem;
            cursor: pointer;
            transition: background 0.2s;
            margin-right: 10px;
        }
        
        .confirm-btn:hover {
            background: #1976D2;
        }
        
        .task-summary {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
            padding: 10px;
            background-color: #2a2a2a;
            border-radius: 5px;
            border: 1px solid #444;
        }
        
        .summary-section h4 {
            margin: 10px 0 5px 0;
            color: #fff;
            font-size: 14px;
        }
        
        .summary-section ul {
            margin: 5px 0 15px 0;
            padding-left: 20px;
        }
        
        .summary-section li {
            margin: 3px 0;
            color: #ccc;
            font-size: 13px;
        }
        
        .message {
            margin-top: 1rem;
            font-size: 1rem;
        }
        
        /* Popup styles */
        .popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .popup-content {
            background-color: #2a2a2a;
            border: 1px solid #666;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            max-width: 350px;
            width: 90%;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .popup-icon {
            font-size: 2rem;
            color: #888;
            margin-bottom: 0.5rem;
        }
        
        .popup-content h3 {
            color: #ccc;
            margin: 0 0 0.5rem 0;
            font-size: 1.2rem;
        }
        
        .popup-content p {
            color: #aaa;
            margin: 0 0 1rem 0;
            font-size: 0.9rem;
        }
        
        /* Gmail Data Section Styles */
        .gmail-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem;
            background: #23272a;
            border-radius: 8px;
            width: 250px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }
        
        .gmail-container h2 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: #888;
            text-align: left;
            font-size: 1rem;
            font-weight: normal;
        }
        
        .gmail-form {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }
        
        .form-group label {
            color: #aaa;
            font-weight: normal;
            font-size: 0.8rem;
        }
        
        .form-group input[type="date"],
        .form-group input[type="number"] {
            padding: 0.4rem;
            border: 1px solid #444;
            border-radius: 4px;
            background: #181a1b;
            color: #f3f3f3;
            font-size: 0.8rem;
        }
        
        .form-group input[type="date"]:focus,
        .form-group input[type="number"]:focus {
            outline: none;
            border-color: #4f8cff;
        }
        
        .get-data-btn {
            background: #4f8cff;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 0.3rem;
        }
        
        .get-data-btn:hover:not(:disabled) {
            background: #357ae8;
        }
        
        .get-data-btn:disabled {
            background: #444;
        }

        .monthly-checkin-form {
            display: grid;
            gap: 0.8rem;
            margin: 1rem 0;
        }

        .monthly-checkin-form .form-group {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 1rem;
        }

        .monthly-checkin-form .form-group label {
            min-width: 120px;
            text-align: right;
            color: #f3f3f3;
            font-size: 0.9rem;
        }

        .monthly-checkin-form .form-group input {
            flex: 1;
            max-width: 80px;
        }

        .month-verification-form {
            display: grid;
            gap: 0.8rem;
            margin: 1rem 0;
        }

        .month-verification-form .form-group {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 1rem;
        }

        .month-verification-form .form-group label {
            min-width: 80px;
            text-align: right;
            color: #f3f3f3;
            font-size: 0.9rem;
        }

        .month-verification-form select,
        .month-verification-form input {
            flex: 1;
            padding: 0.4rem;
            border: 1px solid #444;
            border-radius: 4px;
            background: #181a1b;
            color: #f3f3f3;
            font-size: 0.8rem;
        }

        .month-verification-form select:focus,
        .month-verification-form input:focus {
            outline: none;
            border-color: #4f8cff;
        }
        
        .gmail-message {
            margin-top: 0.5rem;
            font-size: 0.7rem;
            text-align: left;
        }
    </style>
</head>
<body>
    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 800px; margin-bottom: 1rem;">
        <h1>Journal AI</h1>
        <button id="logoutBtn" style="background: #f44336; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; transition: background 0.2s;">Logout</button>
        <button id="loginBtn" style="background: #4CAF50; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; transition: background 0.2s; display: none;">Login</button>
    </div>
    <div class="upload-container" id="drop-area">
        <div class="upload-label">Drag & drop an image here, or</div>
        <button class="browse-btn" id="browseBtn">Browse Computer</button>
        <input type="file" id="fileInput" class="file-input" accept=".jpeg,.jpg,.png" />
        <div class="preview" id="preview"></div>
        <div id="detectionStatus" style="margin-bottom: 1rem; text-align: center; color: #888; font-size: 0.9rem; display: none;">
            <span id="detectionText">Detecting page type...</span>
        </div>
        <button class="submit-btn" id="submitBtn" disabled>Submit</button>
        <button class="todoist-btn" id="todoistBtn" disabled>Add to Todoist</button>
        <div class="message" id="message"></div>
    </div>
    <div class="ocr-result" id="ocrResult"></div>
    
    <!-- Gmail Data Section -->
    <div class="gmail-container" id="gmailContainer" style="display: none;">
        <h2>Get Gmail Data</h2>
        <div class="gmail-form">
            <div class="form-group">
                <label for="sinceDate">Since Date:</label>
                <input type="date" id="sinceDate" />
            </div>
            <div class="form-group">
                <label for="emailLimit">Limit:</label>
                <input type="number" id="emailLimit" value="100" min="1" max="500" />
            </div>
            <button class="get-data-btn" id="getDataBtn">Get Data</button>
        </div>
        <div class="gmail-message" id="gmailMessage"></div>
    </div>
    <!-- Confidence Review Modal -->
    <div id="confidenceModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Review Low Confidence Task</h3>
            <p class="confidence-info">Confidence: <span id="confidenceScore"></span></p>
            <div class="task-review">
                <label for="taskEdit">Task Text:</label>
                <textarea id="taskEdit" rows="3"></textarea>
            </div>
            <div class="modal-buttons">
                <button id="cancelTask" class="cancel-btn">Cancel</button>
                <button id="backTask" class="back-btn" style="display: none;">Back</button>
                <button id="editTask" class="edit-btn">Edit</button>
                <button id="acceptTask" class="accept-btn">Accept</button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Confirm Add to Todoist</h3>
            <p>All tasks have been reviewed. Ready to add the following to Todoist:</p>
            <div class="task-summary" id="taskSummary"></div>
            <div class="modal-buttons">
                <button id="cancelAdd" class="cancel-btn">Cancel</button>
                <button id="confirmAdd" class="confirm-btn">Confirm Add to Todoist</button>
            </div>
        </div>
    </div>

    <!-- Month Verification Modal -->
    <div id="monthVerificationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Verify Month & Year</h3>
            <p>Please verify or correct the month and year for this journal page:</p>
            <div class="month-verification-form">
                <div class="form-group">
                    <label for="monthSelect">Month:</label>
                    <select id="monthSelect">
                        <option value="January">January</option>
                        <option value="February">February</option>
                        <option value="March">March</option>
                        <option value="April">April</option>
                        <option value="May">May</option>
                        <option value="June">June</option>
                        <option value="July">July</option>
                        <option value="August">August</option>
                        <option value="September">September</option>
                        <option value="October">October</option>
                        <option value="November">November</option>
                        <option value="December">December</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="yearInput">Year:</label>
                    <input type="number" id="yearInput" min="2020" max="2030" />
                </div>
            </div>
            <div class="modal-buttons">
                <button id="cancelMonthVerification" class="cancel-btn">Cancel</button>
                <button id="submitMonthVerification" class="confirm-btn">Continue</button>
            </div>
        </div>
    </div>

    <!-- Monthly Check-In Values Modal -->
    <div id="monthlyCheckInModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Verify/Edit Monthly Check-In Values</h3>
            <p>Please enter your wellness ratings (1-10) for each category:</p>
            <div class="monthly-checkin-form">
                <div class="form-group">
                    <label for="relationships">Relationships:</label>
                    <input type="number" id="relationships" min="1" max="10" />
                </div>
                <div class="form-group">
                    <label for="physical">Physical:</label>
                    <input type="number" id="physical" min="1" max="10" />
                </div>
                <div class="form-group">
                    <label for="spiritual">Spiritual:</label>
                    <input type="number" id="spiritual" min="1" max="10" />
                </div>
                <div class="form-group">
                    <label for="workVocation">Work/Vocation:</label>
                    <input type="number" id="workVocation" min="1" max="10" />
                </div>
                <div class="form-group">
                    <label for="personalGrowth">Personal Growth:</label>
                    <input type="number" id="personalGrowth" min="1" max="10" />
                </div>
                <div class="form-group">
                    <label for="play">Play:</label>
                    <input type="number" id="play" min="1" max="10" />
                </div>
                <div class="form-group">
                    <label for="peace">Peace:</label>
                    <input type="number" id="peace" min="1" max="10" />
                </div>
            </div>
            <div class="modal-buttons">
                <button id="cancelMonthlyCheckIn" class="cancel-btn">Cancel</button>
                <button id="submitMonthlyCheckIn" class="confirm-btn">Submit</button>
            </div>
        </div>
    </div>

    <!-- Page Type Confirmation Modal -->
    <div id="pageTypeConfirmModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Confirm Page Type</h3>
            <p>We detected this page as:</p>
            <div style="text-align: center; margin: 1.5rem 0;">
                <div style="font-size: 1.5rem; color: #4f8cff; font-weight: bold;" id="detectedPageType">Daily</div>
                <div style="font-size: 0.8rem; color: #aaa; margin-top: 0.5rem; display: none;" id="detectedReasoning">
                    Analysis in progress...
                </div>
            </div>
            <div class="form-group" style="margin: 1.5rem 0;">
                <label for="pageTypeSelect" style="display: block; margin-bottom: 0.5rem; color: #b0b0b0;">
                    Or select a different page type:
                </label>
                <select id="pageTypeSelect" style="width: 100%; padding: 0.5rem; background: #181a1b; color: #f3f3f3; border: 1px solid #444; border-radius: 4px;">
                    <option value="Daily">Daily</option>
                    <option value="Weekly">Weekly</option>
                    <option value="Monthly">Monthly</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button id="cancelPageType" class="cancel-btn">Cancel</button>
                <button id="confirmPageType" class="confirm-btn">Proceed</button>
            </div>
        </div>
    </div>
    <script>
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('fileInput');
        const browseBtn = document.getElementById('browseBtn');
        const preview = document.getElementById('preview');
        const submitBtn = document.getElementById('submitBtn');
        const message = document.getElementById('message');
        const ocrResult = document.getElementById('ocrResult');
        const todoistBtn = document.getElementById('todoistBtn');
        let selectedFile = null;
        let lastOcrData = null;
        let lowConfidenceTasks = [];
        let currentTaskIndex = 0;
        let reviewedTaskData = null;
        let confidenceThreshold = 0.8; // Default value
        let isDebugMode = false; // Track if logging is set to DEBUG

        // Modal elements
        const confidenceModal = document.getElementById('confidenceModal');
        const confidenceScore = document.getElementById('confidenceScore');
        const taskEdit = document.getElementById('taskEdit');
        const acceptTask = document.getElementById('acceptTask');
        const editTask = document.getElementById('editTask');
        const backTask = document.getElementById('backTask');
        const cancelTask = document.getElementById('cancelTask');
        
        // Confirmation modal elements
        const confirmationModal = document.getElementById('confirmationModal');
        const taskSummary = document.getElementById('taskSummary');
        const confirmAdd = document.getElementById('confirmAdd');
        const cancelAdd = document.getElementById('cancelAdd');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginBtn = document.getElementById('loginBtn');
        
        // Gmail section elements
        const gmailContainer = document.getElementById('gmailContainer');
        const getDataBtn = document.getElementById('getDataBtn');
        const sinceDateInput = document.getElementById('sinceDate');
        const emailLimitInput = document.getElementById('emailLimit');
        const gmailMessage = document.getElementById('gmailMessage');

        // Load configuration on page load
        async function loadConfig() {
            try {
                const response = await fetch('/config');
                if (response.status === 401) {
                    // Redirect to authentication if unauthorized
                    window.location.href = '/auth/google';
                    return;
                }
                const config = await response.json();
                confidenceThreshold = config.task_confidence_threshold;
                isDebugMode = config.log_level === 'DEBUG';
                console.log('Debug mode:', isDebugMode);
            } catch (err) {
                if (err.message && err.message.includes('401')) {
                    // Redirect to authentication if unauthorized
                    window.location.href = '/auth/google';
                    return;
                }
                console.warn('Failed to load config, using default threshold:', confidenceThreshold);
            }
        }

        // Load config when page loads
        loadConfig();
        
        // Set default date to 30 days ago
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        sinceDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
        
        // Global drag and drop prevention when not authenticated
        document.addEventListener('dragover', (e) => {
            if (loginBtn.style.display !== 'none') {
                e.preventDefault();
                e.stopPropagation();
            }
        });
        
        document.addEventListener('drop', (e) => {
            if (loginBtn.style.display !== 'none') {
                e.preventDefault();
                e.stopPropagation();
                message.textContent = 'Please login to upload files.';
                setTimeout(() => {
                    message.textContent = '';
                }, 3000);
            }
        });

        // Flag to prevent infinite redirect loops
        let authCheckInProgress = false;

        // Function to check authentication and update UI accordingly
        async function checkAuthentication() {
            // Prevent multiple simultaneous auth checks
            if (authCheckInProgress) {
                console.log('Authentication check already in progress, skipping...');
                return;
            }
            
            authCheckInProgress = true;
            
            try {
                console.log('Checking authentication status...');
                const response = await fetch('/auth/status');
                const result = await response.json();
                
                console.log('Auth status result:', result);
                
                if (!result.authenticated) {
                    console.log('Not authenticated, showing login button...');
                    // Show login button and hide logout button
                    logoutBtn.style.display = 'none';
                    loginBtn.style.display = 'inline-block';
                    // Disable upload functionality
                    disableUploadFunctionality();
                } else {
                    console.log('Authentication successful, showing logout button...');
                    console.log('About to call enableUploadFunctionality...');
                    // Show logout button and hide login button
                    logoutBtn.style.display = 'inline-block';
                    loginBtn.style.display = 'none';
                    // Enable upload functionality
                    enableUploadFunctionality();
                }
            } catch (error) {
                console.error('Authentication check failed:', error);
                // Show login button on error
                logoutBtn.style.display = 'none';
                loginBtn.style.display = 'inline-block';
                disableUploadFunctionality();
            } finally {
                authCheckInProgress = false;
            }
        }

        // Function to disable upload functionality when not authenticated
        function disableUploadFunctionality() {
            submitBtn.disabled = true;
            todoistBtn.disabled = true;
            browseBtn.disabled = true;
            fileInput.disabled = true;
            dropArea.style.pointerEvents = 'none';
            dropArea.style.opacity = '0.6';
            message.textContent = 'Please login to use the application.';
            ocrResult.style.display = 'none';
            gmailContainer.style.display = 'none';
        }

        // Function to enable upload functionality when authenticated
        function enableUploadFunctionality() {
            console.log('Enabling upload functionality and showing Gmail section');
            submitBtn.disabled = false;
            todoistBtn.disabled = true; // Will be enabled after successful upload
            browseBtn.disabled = false;
            fileInput.disabled = false;
            dropArea.style.pointerEvents = 'auto';
            dropArea.style.opacity = '1';
            message.textContent = '';
            // Don't show ocrResult until there's content
            gmailContainer.style.display = 'block';
            console.log('Gmail container display set to:', gmailContainer.style.display);
        }

        // Logout functionality
        logoutBtn.addEventListener('click', async () => {
            console.log('Logout initiated...');
            
            // Disable logout button to prevent multiple clicks
            logoutBtn.disabled = true;
            
            // Clear the stored credentials on the server
            try {
                const response = await fetch('/auth/logout', { method: 'POST' });
                const result = await response.json();
                console.log('Server logout completed:', result);
            } catch (error) {
                console.error('Server logout failed:', error);
            }
            
            // Clear browser session state
            console.log('Clearing browser session state...');
            sessionStorage.clear();
            localStorage.clear();
            
            // Show logout success popup
            showLogoutSuccessPopup();
            
            // Force a fresh authentication check with a longer delay
            console.log('Forcing fresh authentication check...');
            setTimeout(async () => {
                await checkAuthentication();
                // Re-enable logout button after auth check
                logoutBtn.disabled = false;
            }, 1000); // 1 second delay to ensure server processes logout
        });

        // Login functionality
        loginBtn.addEventListener('click', async () => {
            console.log('Login initiated...');
            
            // Force clear any cached authentication state
            try {
                await fetch('/auth/logout', { method: 'POST' });
                console.log('Forced logout before login');
            } catch (error) {
                console.error('Forced logout failed:', error);
            }
            
            // Clear browser session state
            console.log('Clearing browser session state...');
            sessionStorage.clear();
            localStorage.clear();
            
            // Redirect to OAuth with timestamp to force fresh flow
            const timestamp = Date.now();
            window.location.href = `/auth/google?t=${timestamp}`;
        });

        function isValidImage(file) {
            const validTypes = ['image/jpeg', 'image/png'];
            const validExts = ['.jpeg', '.jpg', '.png'];
            const ext = file.name.toLowerCase().slice(file.name.lastIndexOf('.'));
            return validTypes.includes(file.type) && validExts.includes(ext);
        }

        function showPreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" alt="Preview" />`;
            };
            reader.readAsDataURL(file);
        }

        function resetPreview() {
            preview.innerHTML = '';
        }

        function extractLowConfidenceTasks(ocrData) {
            const tasks = [];
            let taskData;
            
            if (typeof ocrData === 'string') {
                taskData = JSON.parse(ocrData);
            } else {
                taskData = ocrData;
            }
            
            // Extract priority tasks with confidence < 0.9
            if (taskData.prepare_priority) {
                taskData.prepare_priority.forEach((task, index) => {
                    if (task.confidence < confidenceThreshold) {
                        tasks.push({
                            type: 'priority',
                            index: index,
                            task: task.task,
                            confidence: task.confidence,
                            original: task
                        });
                    }
                });
            }
            
            // Extract to-do tasks with confidence < 0.9
            if (taskData.to_do) {
                taskData.to_do.forEach((task, index) => {
                    if (task.confidence < confidenceThreshold) {
                        tasks.push({
                            type: 'todo',
                            index: index,
                            task: task.task,
                            confidence: task.confidence,
                            original: task
                        });
                    }
                });
            }
            
            return tasks;
        }

        function showNextLowConfidenceTask() {
            if (currentTaskIndex >= lowConfidenceTasks.length) {
                // All tasks reviewed, show confirmation dialog
                confidenceModal.style.display = 'none';
                showConfirmationDialog();
                return;
            }
            
            const currentTask = lowConfidenceTasks[currentTaskIndex];
            confidenceScore.textContent = `${(currentTask.confidence * 100).toFixed(1)}%`;
            taskEdit.value = currentTask.task;
            taskEdit.disabled = true; // Start with textarea disabled
            editTask.textContent = 'Edit'; // Reset edit button text
            backTask.style.display = currentTaskIndex > 0 ? 'inline-block' : 'none'; // Show back button for 2nd+ tasks
            confidenceModal.style.display = 'flex';
        }
        
        function showConfirmationDialog() {
            // Generate task summary
            const summary = generateTaskSummary(reviewedTaskData);
            taskSummary.innerHTML = summary;
            confirmationModal.style.display = 'flex';
        }
        
        function generateTaskSummary(taskData) {
            let summary = '<div class="summary-section">';
            
            // Priority tasks
            if (taskData.prepare_priority && taskData.prepare_priority.length > 0) {
                summary += '<h4>Priority Tasks:</h4><ul>';
                taskData.prepare_priority.forEach(task => {
                    const taskText = typeof task === 'string' ? task : task.task;
                    summary += `<li>${taskText}</li>`;
                });
                summary += '</ul>';
            }
            
            // Regular tasks
            if (taskData.to_do && taskData.to_do.length > 0) {
                summary += '<h4>To-Do Tasks:</h4><ul>';
                taskData.to_do.forEach(task => {
                    const taskText = typeof task === 'string' ? task : task.task;
                    summary += `<li>${taskText}</li>`;
                });
                summary += '</ul>';
            }
            
            summary += '</div>';
            return summary;
        }

        function updateTaskInData(taskData, taskType, index, newTaskText) {
            if (taskType === 'priority') {
                taskData.prepare_priority[index].task = newTaskText;
            } else if (taskType === 'todo') {
                taskData.to_do[index].task = newTaskText;
            }
            return taskData;
        }

        function handleFile(file) {
            if (isValidImage(file)) {
                selectedFile = file;
                showPreview(file);
                submitBtn.disabled = false;
                message.textContent = '';
            } else {
                selectedFile = null;
                resetPreview();
                submitBtn.disabled = true;
                message.textContent = 'Only .jpeg, .jpg, or .png files are allowed.';
            }
        }

        browseBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            // Only add dragover styling if authenticated
            if (loginBtn.style.display === 'none') {
                dropArea.classList.add('dragover');
            }
        });
        dropArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropArea.classList.remove('dragover');
        });
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropArea.classList.remove('dragover');
            
            // Only handle files if authenticated
            if (loginBtn.style.display === 'none' && e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            } else {
                // Show message if not authenticated
                message.textContent = 'Please login to upload files.';
                setTimeout(() => {
                    message.textContent = '';
                }, 3000);
            }
        });

        // Global variable to store detection result
        let currentDetectionResult = null;

        submitBtn.addEventListener('click', async () => {
            if (!selectedFile) return;
            submitBtn.disabled = true;
            todoistBtn.disabled = true;
            message.textContent = 'Detecting page type...';
            ocrResult.textContent = '';
            document.getElementById('detectionStatus').style.display = 'block';
            document.getElementById('detectionText').textContent = 'Analyzing page layout...';
            
            // Step 1: Detect page type
            const detectionFormData = new FormData();
            detectionFormData.append('file', selectedFile);
            
            try {
                const detectionResponse = await fetch('/detect-page-type', {
                    method: 'POST',
                    body: detectionFormData
                });
                const detectionResult = await detectionResponse.json();
                
                if (!detectionResponse.ok) {
                    if (detectionResponse.status === 401) {
                        window.location.href = '/auth/google';
                        return;
                    }
                    throw new Error(detectionResult.error || 'Page type detection failed');
                }
                
                // Store detection result and show confirmation modal
                currentDetectionResult = detectionResult;
                showPageTypeConfirmationModal(detectionResult);
                
            } catch (detectionError) {
                console.error('Page type detection failed:', detectionError);
                document.getElementById('detectionText').textContent = 'Detection failed, using Daily as default';
                
                // Create fallback detection result
                currentDetectionResult = {
                    page_type: 'Daily',
                    reasoning: 'Detection failed, using Daily as fallback'
                };
                showPageTypeConfirmationModal(currentDetectionResult);
            }
        });

        // Function to show page type confirmation modal
        function showPageTypeConfirmationModal(detectionResult) {
            document.getElementById('detectedPageType').textContent = detectionResult.page_type;
            
            // Only show reasoning in DEBUG mode
            const reasoningElement = document.getElementById('detectedReasoning');
            if (isDebugMode) {
                reasoningElement.textContent = detectionResult.reasoning || 'No reasoning provided';
                reasoningElement.style.display = 'block';
            } else {
                reasoningElement.style.display = 'none';
            }
            
            document.getElementById('pageTypeSelect').value = detectionResult.page_type;
            document.getElementById('pageTypeConfirmModal').style.display = 'flex';
        }

        // Function to proceed with OCR processing
        async function proceedWithOcrProcessing(selectedPageType) {
            document.getElementById('pageTypeConfirmModal').style.display = 'none';
            
            document.getElementById('detectionText').textContent = 
                `Using: ${selectedPageType} page`;
            message.textContent = 'Processing with selected page type...';
            
            // Step 2: Process with selected page type
            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('category', selectedPageType);
            
            try {
                const response = await fetch('/upload-image', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                if (response.ok) {
                    // Process OCR results
                    lastOcrData = result.ocr_text;
                    todoistBtn.disabled = false; // Re-enable Todoist button after successful upload
                    message.textContent = `Processing complete! (Used: ${selectedPageType})`;
                    
                    if (result.ocr_text) {
                        ocrResult.textContent = result.ocr_text;
                        ocrResult.style.display = 'block';
                    } else {
                        ocrResult.textContent = 'No text detected.';
                        ocrResult.style.display = 'block';
                    }

                    // Show Month Verification modal for monthly uploads
                    if (selectedPageType === 'Monthly') {
                        showMonthVerificationModal(result.ocr_text);
                    }
                } else {
                    if (response.status === 401) {
                        // Redirect to authentication if unauthorized
                        window.location.href = '/auth/google';
                        return;
                    }
                    message.textContent = 'Error: ' + (result.detail || 'Upload failed.');
                    ocrResult.textContent = '';
                    ocrResult.style.display = 'none';
                    todoistBtn.disabled = true;
                    document.getElementById('detectionStatus').style.display = 'none';
                }
            } catch (err) {
                if (err.message && err.message.includes('401')) {
                    // Redirect to authentication if unauthorized
                    window.location.href = '/auth/google';
                    return;
                }
                message.textContent = 'Error: Upload failed.';
                ocrResult.textContent = '';
                ocrResult.style.display = 'none';
                todoistBtn.disabled = true;
                document.getElementById('detectionStatus').style.display = 'none';
            }
            submitBtn.disabled = false;
        }

        todoistBtn.addEventListener('click', async () => {
            if (!lastOcrData) return;
            
            todoistBtn.disabled = true;
            message.textContent = 'Preparing tasks for Todoist...';
            
            // Extract low confidence tasks
            lowConfidenceTasks = extractLowConfidenceTasks(lastOcrData);
            
            if (lowConfidenceTasks.length === 0) {
                // No low confidence tasks, proceed directly
                uploadToTodoist(lastOcrData);
            } else {
                // Start confidence review process
                currentTaskIndex = 0;
                reviewedTaskData = typeof lastOcrData === 'string' ? JSON.parse(lastOcrData) : lastOcrData;
                showNextLowConfidenceTask();
            }
        });

        async function uploadToTodoist(taskData) {
            try {
                const response = await fetch('/upload-to-todoist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(taskData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    message.textContent = `Todoist: ${result.message}`;
                } else {
                    if (response.status === 401) {
                        // Redirect to authentication if unauthorized
                        window.location.href = '/auth/google';
                        return;
                    }
                    message.textContent = 'Error: ' + (result.detail || 'Failed to add to Todoist.');
                }
            } catch (err) {
                if (err.message && err.message.includes('401')) {
                    // Redirect to authentication if unauthorized
                    window.location.href = '/auth/google';
                    return;
                }
                message.textContent = 'Error: Failed to add to Todoist.';
            }
            
            todoistBtn.disabled = false;
        }

        // Modal event handlers
        editTask.addEventListener('click', () => {
            if (taskEdit.disabled) {
                // Enable editing
                taskEdit.disabled = false;
                taskEdit.focus();
                editTask.textContent = 'Done';
            } else {
                // Disable editing
                taskEdit.disabled = true;
                editTask.textContent = 'Edit';
            }
        });

        backTask.addEventListener('click', () => {
            if (currentTaskIndex > 0) {
                // Save current task changes before going back
                const currentTask = lowConfidenceTasks[currentTaskIndex];
                const updatedTaskText = taskEdit.value.trim();
                reviewedTaskData = updateTaskInData(reviewedTaskData, currentTask.type, currentTask.index, updatedTaskText);
                
                // Go back to previous task
                currentTaskIndex--;
                showNextLowConfidenceTask();
            }
        });

        cancelTask.addEventListener('click', () => {
            confidenceModal.style.display = 'none';
            todoistBtn.disabled = false; // Re-enable Todoist button
            message.textContent = 'Todoist upload cancelled.';
        });

        acceptTask.addEventListener('click', () => {
            const currentTask = lowConfidenceTasks[currentTaskIndex];
            const updatedTaskText = taskEdit.value.trim();
            
            // Update the task data with the reviewed text
            reviewedTaskData = updateTaskInData(reviewedTaskData, currentTask.type, currentTask.index, updatedTaskText);
            
            // Move to next task
            currentTaskIndex++;
            showNextLowConfidenceTask();
        });

        // Confirmation modal event handlers
        confirmAdd.addEventListener('click', () => {
            confirmationModal.style.display = 'none';
            uploadToTodoist(reviewedTaskData);
        });
        
        cancelAdd.addEventListener('click', () => {
            confirmationModal.style.display = 'none';
            todoistBtn.disabled = false;
        });
        
        // Close modals when clicking outside
        confidenceModal.addEventListener('click', (e) => {
            if (e.target === confidenceModal) {
                confidenceModal.style.display = 'none';
                todoistBtn.disabled = false;
                message.textContent = 'Todoist upload cancelled.';
            }
        });
        
        confirmationModal.addEventListener('click', (e) => {
            if (e.target === confirmationModal) {
                confirmationModal.style.display = 'none';
                todoistBtn.disabled = false;
            }
        });
        
        // Function to show logout success popup
        function showLogoutSuccessPopup() {
            const popup = document.createElement('div');
            popup.className = 'popup';
            popup.innerHTML = `
                <div class="popup-content">
                    <div class="popup-icon">✓</div>
                    <h3>Logout Successful</h3>
                    <p>You have been successfully logged out.</p>
                    <button onclick="closePopup()" class="btn btn-primary">OK</button>
                </div>
            `;
            document.body.appendChild(popup);
            
            // Auto-close after 6 seconds
            setTimeout(() => {
                if (popup.parentNode) {
                    closePopup();
                }
            }, 6000);
        }

        // Function to close popup
        function closePopup() {
            const popup = document.querySelector('.popup');
            if (popup) {
                popup.remove();
            }
        }
        
        // Gmail Data functionality
        getDataBtn.addEventListener('click', async () => {
            const sinceDate = sinceDateInput.value;
            const limit = parseInt(emailLimitInput.value);
            
            if (!sinceDate) {
                gmailMessage.textContent = 'Please select a date.';
                gmailMessage.style.color = '#ff6b6b';
                return;
            }
            
            if (!limit || limit < 1 || limit > 500) {
                gmailMessage.textContent = 'Please enter a valid limit (1-500).';
                gmailMessage.style.color = '#ff6b6b';
                return;
            }
            
            getDataBtn.disabled = true;
            gmailMessage.textContent = 'Fetching Gmail data...';
            gmailMessage.style.color = '#4f8cff';
            
            try {
                const response = await fetch('/gmail/fetch-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        since_date: sinceDate,
                        limit: limit
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    gmailMessage.textContent = `Success: ${result.message}`;
                    gmailMessage.style.color = '#1db954';
                } else {
                    if (response.status === 401) {
                        // Redirect to authentication if unauthorized
                        window.location.href = '/auth/google';
                        return;
                    }
                    gmailMessage.textContent = 'Error: ' + (result.detail || 'Failed to fetch Gmail data.');
                    gmailMessage.style.color = '#ff6b6b';
                }
            } catch (err) {
                if (err.message && err.message.includes('401')) {
                    // Redirect to authentication if unauthorized
                    window.location.href = '/auth/google';
                    return;
                }
                gmailMessage.textContent = 'Error: Failed to fetch Gmail data.';
                gmailMessage.style.color = '#ff6b6b';
            }
            
            getDataBtn.disabled = false;
        });

        // Global variable to store OCR data between modals
        let currentOcrData = null;

        // Month Verification Modal Functions
        function showMonthVerificationModal(ocrData) {
            currentOcrData = ocrData;
            const modal = document.getElementById('monthVerificationModal');
            
            // Pre-fill month and year from OCR if available
            try {
                const parsedData = JSON.parse(ocrData);
                if (parsedData.month && parsedData.month.month && parsedData.month.year) {
                    // Backend has already parsed and normalized the month/year format
                    document.getElementById('monthSelect').value = parsedData.month.month;
                    document.getElementById('yearInput').value = parsedData.month.year;
                } else {
                    // Set to current month/year as fallback
                    const now = new Date();
                    const currentMonth = now.toLocaleString('default', { month: 'long' });
                    document.getElementById('monthSelect').value = currentMonth;
                    document.getElementById('yearInput').value = now.getFullYear();
                }
            } catch (e) {
                console.log('Could not pre-fill month/year from OCR data');
                // Set to current month/year as fallback
                const now = new Date();
                const currentMonth = now.toLocaleString('default', { month: 'long' });
                document.getElementById('monthSelect').value = currentMonth;
                document.getElementById('yearInput').value = now.getFullYear();
            }
            
            modal.style.display = 'block';
        }

        function hideMonthVerificationModal() {
            const modal = document.getElementById('monthVerificationModal');
            modal.style.display = 'none';
        }

        function updateOcrDataWithMonth() {
            const selectedMonth = document.getElementById('monthSelect').value;
            const selectedYear = parseInt(document.getElementById('yearInput').value);

            // Update the currentOcrData with corrected month in new format
            try {
                const parsedData = JSON.parse(currentOcrData);
                if (!parsedData.month) {
                    parsedData.month = {};
                }
                parsedData.month.month = selectedMonth;
                parsedData.month.year = selectedYear;
                parsedData.month.confidence = 1.0; // High confidence for manually verified value
                
                currentOcrData = JSON.stringify(parsedData, null, 2);
                
                // Update lastOcrData as well
                lastOcrData = currentOcrData;
                
                // Update the displayed OCR result
                ocrResult.textContent = lastOcrData;
                
            } catch (e) {
                console.error('Error updating OCR data with month:', e);
            }
        }

        // Monthly Check-In Modal Functions
        function showMonthlyCheckInModal() {
            const modal = document.getElementById('monthlyCheckInModal');
            
            // Pre-fill values from OCR if available
            try {
                const parsedData = JSON.parse(currentOcrData);
                if (parsedData.monthly_check_in) {
                    const monthlyData = parsedData.monthly_check_in;
                    
                    if (monthlyData.relationships) document.getElementById('relationships').value = monthlyData.relationships;
                    if (monthlyData.physical) document.getElementById('physical').value = monthlyData.physical;
                    if (monthlyData.spiritual) document.getElementById('spiritual').value = monthlyData.spiritual;
                    if (monthlyData['work/vocation']) document.getElementById('workVocation').value = monthlyData['work/vocation'];
                    if (monthlyData['personal growth']) document.getElementById('personalGrowth').value = monthlyData['personal growth'];
                    if (monthlyData.play) document.getElementById('play').value = monthlyData.play;
                    if (monthlyData.peace) document.getElementById('peace').value = monthlyData.peace;
                }
            } catch (e) {
                console.log('Could not pre-fill values from OCR data');
            }
            
            modal.style.display = 'block';
        }

        function hideMonthlyCheckInModal() {
            const modal = document.getElementById('monthlyCheckInModal');
            modal.style.display = 'none';
            
            // Clear form values
            document.getElementById('relationships').value = '';
            document.getElementById('physical').value = '';
            document.getElementById('spiritual').value = '';
            document.getElementById('workVocation').value = '';
            document.getElementById('personalGrowth').value = '';
            document.getElementById('play').value = '';
            document.getElementById('peace').value = '';
        }

        function updateOcrDataWithMonthlyCheckIn() {
            // Get values from form
            const monthlyCheckInValues = {
                relationships: parseInt(document.getElementById('relationships').value) || null,
                physical: parseInt(document.getElementById('physical').value) || null,
                spiritual: parseInt(document.getElementById('spiritual').value) || null,
                'work/vocation': parseInt(document.getElementById('workVocation').value) || null,
                'personal growth': parseInt(document.getElementById('personalGrowth').value) || null,
                play: parseInt(document.getElementById('play').value) || null,
                peace: parseInt(document.getElementById('peace').value) || null
            };

            // Remove null values
            Object.keys(monthlyCheckInValues).forEach(key => {
                if (monthlyCheckInValues[key] === null) {
                    delete monthlyCheckInValues[key];
                }
            });

            // Update the currentOcrData with manual values
            try {
                const parsedData = JSON.parse(currentOcrData);
                parsedData.monthly_check_in = monthlyCheckInValues;
                currentOcrData = JSON.stringify(parsedData, null, 2);
                lastOcrData = currentOcrData; // Update lastOcrData as well
                
                // Update the displayed OCR result
                ocrResult.textContent = lastOcrData;
                
                message.textContent = 'Monthly Check-In values updated!';
                setTimeout(() => {
                    message.textContent = '';
                }, 2000);
            } catch (e) {
                console.error('Error updating OCR data with monthly check-in values:', e);
                message.textContent = 'Error updating values';
            }
        }

        // Month Verification Modal event listeners
        document.getElementById('cancelMonthVerification').addEventListener('click', hideMonthVerificationModal);
        document.getElementById('submitMonthVerification').addEventListener('click', () => {
            updateOcrDataWithMonth();
            hideMonthVerificationModal();
            showMonthlyCheckInModal(); // Continue to Monthly Check-In modal
        });

        // Close month verification modal when clicking outside
        document.getElementById('monthVerificationModal').addEventListener('click', (e) => {
            if (e.target.id === 'monthVerificationModal') {
                hideMonthVerificationModal();
            }
        });

        // Monthly Check-In Modal event listeners
        document.getElementById('cancelMonthlyCheckIn').addEventListener('click', hideMonthlyCheckInModal);
        document.getElementById('submitMonthlyCheckIn').addEventListener('click', () => {
            updateOcrDataWithMonthlyCheckIn();
            hideMonthlyCheckInModal();
        });

        // Close modal when clicking outside
        document.getElementById('monthlyCheckInModal').addEventListener('click', (e) => {
            if (e.target.id === 'monthlyCheckInModal') {
                hideMonthlyCheckInModal();
            }
        });

        // Page Type Confirmation Modal event listeners
        document.getElementById('confirmPageType').addEventListener('click', () => {
            const selectedPageType = document.getElementById('pageTypeSelect').value;
            proceedWithOcrProcessing(selectedPageType);
        });

        document.getElementById('cancelPageType').addEventListener('click', () => {
            document.getElementById('pageTypeConfirmModal').style.display = 'none';
            document.getElementById('detectionStatus').style.display = 'none';
            submitBtn.disabled = false;
            message.textContent = 'Processing cancelled.';
        });

        // Close page type modal when clicking outside
        document.getElementById('pageTypeConfirmModal').addEventListener('click', (e) => {
            if (e.target.id === 'pageTypeConfirmModal') {
                document.getElementById('pageTypeConfirmModal').style.display = 'none';
                document.getElementById('detectionStatus').style.display = 'none';
                submitBtn.disabled = false;
                message.textContent = 'Processing cancelled.';
            }
        });
        
        // Check authentication status on page load
        checkAuthentication();
    </script>
</body>
</html> 